<!-- ABOUTME: Displays a minimalist icebreaker question viewer with Firestore integration. -->
<!-- ABOUTME: Fetches, randomizes, and adds questions using Firebase's modular SDK. -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Icebreaker Questions</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', sans-serif;
        background: #f4f4f0;
        color: #1a1a1a;
      }

      main {
        width: min(720px, 90vw);
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }

      h1 {
        font-size: clamp(2rem, 4vw, 3.5rem);
        font-weight: 500;
        line-height: 1.3;
        margin: 0;
      }

      .actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      button {
        background: transparent;
        border: 1px solid #1a1a1a;
        color: #1a1a1a;
        padding: 0.75rem 1.75rem;
        font-size: 1rem;
        font-family: inherit;
        border-radius: 999px;
        transition: background 0.2s ease, color 0.2s ease;
        cursor: pointer;
      }

      button:hover {
        background: #1a1a1a;
        color: #f4f4f0;
      }

      form {
        display: none;
        gap: 1rem;
        flex-direction: column;
        align-items: center;
      }

      form.active {
        display: flex;
      }

      input {
        width: min(420px, 90vw);
        padding: 0.75rem 1rem;
        border-radius: 999px;
        border: 1px solid #1a1a1a;
        font-size: 1rem;
        font-family: inherit;
        background: transparent;
        color: inherit;
      }

      .helper {
        font-size: 0.95rem;
        color: rgba(26, 26, 26, 0.7);
        margin: 0;
      }
    </style>
  </head>
  <body>
    <main>
      <h1 id="question">Loading questionâ€¦</h1>
      <p class="helper">hmm</p>
      <div class="actions">
        <button id="next" type="button">Next</button>
        <button id="add" type="button">Add</button>
      </div>
      <form id="form">
        <input
          id="input"
          type="text"
          placeholder="Add a new question"
          autocomplete="off"
        />
        <button id="submit" type="submit">Submit</button>
      </form>
    </main>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
      } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
      import { createQuestionQueue } from './question-queue.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyDrfolJCLUeizZkkAOACygxRcV9Kv1Weds',
        authDomain: 'icebreaker-fd620.firebaseapp.com',
        projectId: 'icebreaker-fd620',
        storageBucket: 'icebreaker-fd620.firebasestorage.app',
        messagingSenderId: '24703380392',
        appId: '1:24703380392:web:c743834816325a12c50b9d',
        measurementId: 'G-J3XN49FGV6',
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const questionsCollection = collection(db, 'questions');

      const questionEl = document.getElementById('question');
      const nextButton = document.getElementById('next');
      const addButton = document.getElementById('add');
      const form = document.getElementById('form');
      const input = document.getElementById('input');

      let questions = [];
      const questionQueue = createQuestionQueue();

      const shuffleQuestions = (items) => {
        const shuffled = [...items];

        for (let index = shuffled.length - 1; index > 0; index -= 1) {
          const swapIndex = Math.floor(Math.random() * (index + 1));
          [shuffled[index], shuffled[swapIndex]] = [
            shuffled[swapIndex],
            shuffled[index],
          ];
        }

        return shuffled;
      };

      const pickRandomQuestion = () => {
        const nextQuestion = questionQueue.next();
        if (!nextQuestion) {
          questionEl.textContent = 'No questions yet. Add the first one!';
          return;
        }

        questionEl.textContent = nextQuestion;
      };

      const loadQuestions = async () => {
        try {
          const snapshot = await getDocs(questionsCollection);
          questions = snapshot.docs
            .map((doc) => doc.data()?.text)
            .filter((text) => typeof text === 'string');
          questionQueue.setQuestions(shuffleQuestions(questions));
          pickRandomQuestion();
        } catch (error) {
          questionEl.textContent = 'Unable to load questions right now.';
        }
      };

      nextButton.addEventListener('click', () => {
        pickRandomQuestion();
      });

      addButton.addEventListener('click', () => {
        form.classList.toggle('active');
        if (form.classList.contains('active')) {
          input.focus();
        }
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const value = input.value.trim();

        if (!value) {
          alert('Please enter a question.');
          return;
        }

        try {
          await addDoc(questionsCollection, { text: value });
          questions = [...questions, value];
          questionQueue.addQuestion(value);
          input.value = '';
          form.classList.remove('active');
          alert('Question added.');
          pickRandomQuestion();
        } catch (error) {
          alert('Unable to add the question right now.');
        }
      });

      loadQuestions();
    </script>
  </body>
</html>
